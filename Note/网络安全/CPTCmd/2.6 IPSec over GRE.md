# R1 PAT配置

access-list 1 permit 192.168.2.0 0.0.0.255
interface Fa0/0
ip nat inside
interface Se0/3/0
ip nat outside
ip nat inside source list 1 interface Se0/3/0 overload

# R0 配置IPSec VPN

crypto isakmp policy 1
hash md5
encryption des
authentication pre-share
crypto isakmp key wxit address 210.28.144.2
// wxit: 预共享密钥(Pre-shared Key), 必须与对端R1上配置的密钥完全一致, 作为双方身份验证的密码
// address 210.28.144.2: 指定这个密钥是用于和公网IP为 210.28.144.2 的对等体(Peer)进行通信的, 也就是R1
crypto ipsec transform-set wxitvpn esp-des esp-md5-hmac
access-list 110 permit gre 58.1.1.0 0.0.0.3 210.28.144.0 0.0.0.3
// 一个极其关键的ACL, 定义了需要被IPSec加密的流量
// permit gre: 表示只对GRE协议的流量感兴趣
// 58.1.1.0 0.0.0.3: 匹配源地址 58.1.1.0是R0公网IP所在网段 0.0.0.3是/30的反向掩码 这匹配了从R0发出的GRE包
// 210.28.144.0 0.0.0.3: 匹配目标地址 210.28.144.0是R1公网IP所在网段 这匹配了发往R1的GRE包
crypto map wxitmap 1 ipsec-isakmp
set peer 210.28.144.2
set transform-set wxitvpn
match address 110
interface Se0/3/0
crypto map wxitmap

# R1 配置IPSec VPN

crypto isakmp policy 1
hash md5
encryption des
authentication pre-share
crypto isakmp key wxit address 58.1.1.1
crypto ipsec transform-set wxitvpn esp-des esp-md5-hmac
access-list 110 permit gre 210.28.144.0 0.0.0.3 58.1.1.0 0.0.0.3
crypto map wxitmap 1 ipsec-isakmp
set peer 58.1.1.1
set transform-set wxitvpn
match address 110
interface Se0/3/0
crypto map wxitmap

# R0 配置GRE VPN

interface Tunnel1
tunnel source Se0/3/0 // 指定GRE数据包的源IP将使用Se0/3/0接口的IP，即R0的公网IP 58.1.1.1
ip address 58.1.2.1 255.255.255.252 // 为虚拟隧道接口本身分配一个IP地址, 58.1.2.0/30 是专门为这个隧道链路规划的一个独立网段, R0这端是.1, R1那端就是.2, 它们通过此地址通信
tunnel destination 210.28.144.2 // 指定GRE数据包的目的IP，即R1的公网IP 210.28.144.2
ip route 0.0.0.0 0.0.0.0 Se0/3/0
ip route 192.168.2.0 255.255.255.0 58.1.2.2 // 这是一个静态路由, 它告诉R0路由器, 要访问对面的局域网192.168.2.0/24, 应该把数据包发给58.1.2.2

# R1 配置GRE VPN

interface Tunnel1
tunnel source Se0/3/0
ip address 58.1.2.2 255.255.255.252
tunnel destination 58.1.1.1
ip route 0.0.0.0 0.0.0.0 Se0/3/0
ip route 192.168.1.0 255.255.255.0 58.1.2.1

实验结果

1. pc0(192.168.1.1) ping pc1(192.168.1.2), 通, 但是在R0 show ip nat translations无nat转换记录(命令无输出)

2. pc0 ping 外网(210.28.144.2), 通, 在R0 show ip nat translations有nat转换记录

   ```shell
   Pro  Inside global     Inside local       Outside local      Outside global
   icmp 58.1.1.1:13       192.168.1.1:13     210.28.144.2:13    210.28.144.2:13
   icmp 58.1.1.1:14       192.168.1.1:14     210.28.144.2:14    210.28.144.2:14
   icmp 58.1.1.1:15       192.168.1.1:15     210.28.144.2:15    210.28.144.2:15
   icmp 58.1.1.1:16       192.168.1.1:16     210.28.144.2:16    210.28.144.2:16
   ```

3. 在R0, R1上使用show crypto isakmp sa查看VPN建立情况

   ```shell
   IPv4 Crypto ISAKMP SA
   dst             src             state          conn-id slot status
   210.28.144.2    58.1.1.1        QM_IDLE           1004    0 ACTIVE
   IPv6 Crypto ISAKMP SA
   ```

~~4. 仿真模式, 用pc0 ping pc3, 单步运行~~

实验总结
私有IP地址192.168.1.x和192.168.2.x，公网上无法被路由, PAT作用: 当内部电脑需要访问公共网络时，路由器会将源IP（私有IP）转换成自己的公网IP地址。这样，外部网络看来，所有请求都来自于路由器。这是为了让内网电脑能访问公网资源。

GRE隧道：一条虚拟的点对点网线。作用是把一个完整的IP包（比如从 192.168.1.1 发往 192.168.2.1 的包）装进另一个IP包里。新的外层IP包的源和目的地址是两个路由器的公网IP（58.1.1.1 和 210.28.144.2）。这样，私有地址的数据包就能在公共网络上传输了。但GRE本身不提供加密。

IPSec：这是一种提供网络层安全性的协议套件。它通过加密和验证来保护IP通信。在实验中，IPSec的作用并不是直接加密PC之间的数据包，而是加密GRE隧道本身的数据包。这就叫“GRE over IPSec”，既利用了GRE能够封装多种协议的灵活性，又利用了IPSec的强大安全性。
